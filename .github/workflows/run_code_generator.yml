name: "Run Code Generator"
run-name: "ðŸ¤– Code Generator"

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name (e.g., main)'
        required: true
        default: 'main'
      research_topic:
        description: 'Research topic or area of focus'
        required: true
      research_hypothesis:
        description: 'Research hypothesis (JSON/YAML text)'
        required: true
      experimental_design:
        description: 'Experimental design (JSON/YAML text)'
        required: true
      wandb_config:
        description: 'WandB config (JSON/YAML text: entity/project)'
        required: true
      github_actions_agent:
        description: 'AI agent tool to use (claude_code or open_code)'
        required: true
        type: choice
        options:
          - claude_code
          - open_code
        default: 'claude_code'
      model_name:
        description: 'Model to use (for OpenCode: openrouter/openai/gpt-5-nano, for Claude Code: sonnet/opus/haiku)'
        required: true
        default: 'sonnet'
      # NOTE: Use prompt_path instead of passing prompt directly to avoid
      # "Argument list too long" error in AI agent tools (OpenCode/ClaudeCode)
      prompt_path:
        description: 'Path to the prompt template file'
        required: false
        default: '.github/prompts/run_code_generator.md'

permissions:
  id-token: write
  contents: write
  actions: write

defaults:
  run:
    shell: bash

jobs:
  codegen:
    name: Generate Code
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch_name }}

      - name: Build code generation prompt
        id: build-prompt
        env:
          PROMPT_PATH: ${{ github.event.inputs.prompt_path }}
          RESEARCH_TOPIC: ${{ github.event.inputs.research_topic }}
          RESEARCH_HYPOTHESIS: ${{ github.event.inputs.research_hypothesis }}
          EXPERIMENTAL_DESIGN: ${{ github.event.inputs.experimental_design }}
          WANDB_CONFIG: ${{ github.event.inputs.wandb_config }}
        run: |
          set -e
          if [ ! -f "$PROMPT_PATH" ]; then
            echo "::error::Prompt file not found: $PROMPT_PATH"
            exit 1
          fi

          PROMPT_FILE="/tmp/code_generator_prompt.txt"
          {
            cat "$PROMPT_PATH"
            echo ""
            echo "INPUT_DATA:"
            echo "research_topic:"
            printf "%s\n" "$RESEARCH_TOPIC"
            echo "research_hypothesis:"
            printf "%s\n" "$RESEARCH_HYPOTHESIS"
            echo "experimental_design:"
            printf "%s\n" "$EXPERIMENTAL_DESIGN"
            echo "wandb_config:"
            printf "%s\n" "$WANDB_CONFIG"
          } > "$PROMPT_FILE"

          echo "prompt_file=$PROMPT_FILE" >> "$GITHUB_OUTPUT"
          echo "Prompt saved to: $PROMPT_FILE ($(wc -c < "$PROMPT_FILE") bytes)"

      - name: Run Claude Code for code generation
        if: github.event.inputs.github_actions_agent == 'claude_code'
        uses: ./.github/actions/run-claude-code
        with:
          prompt_file: ${{ steps.build-prompt.outputs.prompt_file }}
          model_name: ${{ github.event.inputs.model_name }}
          allowed_tools: '*'
          timeout_minutes: '15'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}

      - name: Run OpenCode for code generation
        if: github.event.inputs.github_actions_agent == 'open_code'
        uses: ./.github/actions/run-open-code
        with:
          prompt_file: ${{ steps.build-prompt.outputs.prompt_file }}
          model_name: ${{ github.event.inputs.model_name }}
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASEURL: ${{ secrets.LANGFUSE_BASE_URL }}

          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_VERSION: "2024-10-01-preview"

          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Commit and push code generation changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git add Dockerfile config/ src/ pyproject.toml

          if ! git diff --staged --quiet; then
            git commit -m "[CI] Code generation changes using ${{ github.event.inputs.github_actions_agent }}"
            for i in {1..5}; do
              git pull --rebase -X theirs origin ${{ github.event.inputs.branch_name }}
              git push && break
              echo "Push failed on attempt $i. Retrying in $((2**i)) seconds..."
              sleep $((2**i))
            done
          else
            echo "Code generation made no changes to the code."
          fi
